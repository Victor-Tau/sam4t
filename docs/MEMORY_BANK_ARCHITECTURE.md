# SAMURAI Memory Bank ç»´æŠ¤æœºåˆ¶è¯¦è§£

## ğŸ¯ æ¦‚è¿°

SAMURAIæ¨¡å‹çš„Memory Bankæ˜¯è§†é¢‘ç›®æ ‡è·Ÿè¸ªçš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒåœ¨**æœ‰é™å®¹é‡**å†…å­˜å‚¨å†å²å¸§çš„è§†è§‰ä¿¡æ¯å’Œç›®æ ‡çŠ¶æ€ï¼Œå¸®åŠ©æ¨¡å‹åœ¨å½“å‰å¸§è¿›è¡Œå‡†ç¡®çš„åˆ†å‰²å’Œè·Ÿè¸ªã€‚

**ğŸ”‘ æ ¸å¿ƒç†è§£**ï¼š
- **å­˜å‚¨ç­–ç•¥**ï¼šSAMURAIä¸SAM 2éƒ½ä¿å­˜æ‰€æœ‰å†å²å¸§ï¼ˆæ”¯æŒåŒå‘è·Ÿè¸ªå’Œäº¤äº’ï¼‰
- **ä½¿ç”¨ç­–ç•¥**ï¼šæ¯æ¬¡æ¨ç†å›ºå®šä½¿ç”¨7å¸§ï¼ˆä¿æŒGPUå†…å­˜å’Œè®¡ç®—å¼€é”€æ’å®šï¼‰
- **åˆ›æ–°ç‚¹**ï¼šå¼•å…¥ä¸‰å±‚æ¶æ„ï¼Œé€šè¿‡è´¨é‡é©±åŠ¨çš„å€™é€‰æ± æ™ºèƒ½é€‰æ‹©æœ€ä¼˜çš„7å¸§
- **å†…å­˜æ•ˆç‡**ï¼šGPUå ç”¨ä¸SAM 2å®Œå…¨ç›¸åŒï¼ŒCPUå ç”¨ç›¸åŒï¼ˆoffloadæœºåˆ¶ï¼‰

è¿™ä½¿å¾—SAMURAIèƒ½å¤Ÿåœ¨**é›¶é¢å¤–GPUå¼€é”€**çš„å‰æä¸‹ï¼Œé€šè¿‡æ›´æ™ºèƒ½çš„å¸§é€‰æ‹©æ˜¾è‘—æå‡è·Ÿè¸ªæ€§èƒ½ã€‚

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µï¼šä¸‰å±‚æ¶æ„

åœ¨æ·±å…¥ç»†èŠ‚å‰ï¼Œå¿…é¡»ç†è§£SAMURAI Memory Bankçš„ä¸‰å±‚æ¶æ„ï¼š

```
ğŸ“Š SAMURAI Memory Bank ä¸‰å±‚æ¶æ„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚ï¼šoutput_dict["non_cond_frame_outputs"]            â”‚
â”‚ â”œâ”€ å­˜å‚¨ï¼šæ‰€æœ‰è·Ÿè¸ªè¿‡çš„å†å²å¸§ï¼ˆå¯èƒ½å‡ ç™¾ä¸Šåƒå¸§ï¼‰            â”‚
â”‚ â”œâ”€ ä½ç½®ï¼šCPUå†…å­˜ï¼ˆoffloadä¼˜åŒ–ï¼‰                        â”‚
â”‚ â””â”€ ä½œç”¨ï¼šå®Œæ•´å†å²è®°å½•ï¼Œæ”¯æŒåŒå‘è·Ÿè¸ªå’Œç”¨æˆ·äº¤äº’            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ è´¨é‡è¿‡æ»¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2å±‚ï¼švalid_indicesï¼ˆé«˜è´¨é‡å¸§å€™é€‰æ± ï¼‰                   â”‚
â”‚ â”œâ”€ å­˜å‚¨ï¼šé€šè¿‡ä¸‰é‡è´¨é‡æ£€æŸ¥çš„å¸§ç´¢å¼•ï¼ˆæœ€å¤š15ä¸ªï¼‰            â”‚
â”‚ â”œâ”€ ä½ç½®ï¼šä¸´æ—¶å˜é‡ï¼ˆæ¯å¸§é‡æ–°è®¡ç®—ï¼‰                       â”‚
â”‚ â””â”€ ä½œç”¨ï¼šè´¨é‡è¿‡æ»¤åçš„å€™é€‰é›†                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ é€‰æ‹©æœ€è¿‘6ä¸ª
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å±‚ï¼šMemory Bankï¼ˆçœŸæ­£ç”¨äºæ¨ç†çš„å¸§ï¼‰                   â”‚
â”‚ â”œâ”€ å­˜å‚¨ï¼š1ä¸ªconditioning frame + 6ä¸ªnon-conditioning    â”‚
â”‚ â”œâ”€ ä½ç½®ï¼šGPUå†…å­˜ï¼ˆç”¨äºMemory Attentionï¼‰               â”‚
â”‚ â””â”€ ä½œç”¨ï¼šå®é™…å‚ä¸å½“å‰å¸§æ¨ç†è®¡ç®—                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®è¦ç‚¹**ï¼š
- âœ… ç¬¬1å±‚ä¿å­˜**æ‰€æœ‰**å†å²å¸§ï¼ˆSAM 2å’ŒSAMURAIéƒ½æ˜¯å¦‚æ­¤ï¼‰
- ğŸ”„ ç¬¬2å±‚æ˜¯SAMURAIçš„**æ ¸å¿ƒåˆ›æ–°**ï¼ˆè´¨é‡é©±åŠ¨çš„å€™é€‰æ± ï¼‰
- âœ… ç¬¬3å±‚å›ºå®šä½¿ç”¨**7å¸§**ï¼ˆSAM 2å’ŒSAMURAIç›¸åŒå®¹é‡ï¼‰

**å…·ä½“ç¤ºä¾‹**ï¼ˆè·Ÿè¸ªåˆ°ç¬¬100å¸§ï¼‰ï¼š

```python
# ç¬¬1å±‚ï¼šoutput_dictï¼ˆå®Œæ•´å†å²ï¼‰
output_dict["non_cond_frame_outputs"] = {
    1: {...}, 2: {...}, ..., 98: {...}, 99: {...}  # 99ä¸ªå¸§çš„å®Œæ•´æ•°æ®
}

# ç¬¬2å±‚ï¼švalid_indicesï¼ˆè´¨é‡è¿‡æ»¤ï¼‰
valid_indices = [85, 87, 91, 92, 94, 95, 97, 98, 99]  # 9ä¸ªé«˜è´¨é‡å¸§

# ç¬¬3å±‚ï¼šMemory Bankï¼ˆå®é™…ä½¿ç”¨ï¼‰
memory_bank_frames = [
    conditioning_frame_0,                       # 1ä¸ªconditioning frame
    valid_indices[-6:] = [92, 94, 95, 97, 98, 99]  # ä»å€™é€‰æ± é€‰æœ€è¿‘6ä¸ª
]  # æ€»å…±7å¸§ç”¨äºMemory Attention
```

---

## ğŸ“¦ ä¸€ã€Memory Bankçš„æ ¸å¿ƒç»“æ„

### 1.1 é…ç½®å‚æ•°

```yaml
# sam2/sam2/configs/samurai/sam2.1_hiera_b+.yaml
num_maskmem: 7                    # é»˜è®¤1ä¸ªè¾“å…¥å¸§ + 6ä¸ªå†å²å¸§
memory_bank_iou_threshold: 0.5    # æ©ç è´¨é‡é˜ˆå€¼
memory_bank_obj_score_threshold: 0.0  # ç›®æ ‡å­˜åœ¨é˜ˆå€¼
memory_bank_kf_score_threshold: 0.0   # è¿åŠ¨ä¸€è‡´æ€§é˜ˆå€¼
max_obj_ptrs_in_encoder: 16       # æœ€å¤§å¯¹è±¡æŒ‡é’ˆæ•°é‡
```

Memory Banké‡‡ç”¨**å›ºå®šä½¿ç”¨å®¹é‡è®¾è®¡**ï¼Œæ¯æ¬¡æ¨ç†ä½¿ç”¨**7ä¸ªå¸§**çš„ä¿¡æ¯ï¼š
- **1ä¸ªconditioning frame**ï¼ˆç”¨æˆ·æ ‡æ³¨çš„åˆå§‹å¸§ï¼‰
- **6ä¸ªå†å²è®°å¿†å¸§**ï¼ˆnon-conditioning framesï¼‰

**ğŸ”‘ å­˜å‚¨æœºåˆ¶å…³é”®ç‚¹ï¼ˆé‡è¦æ¾„æ¸…ï¼‰**ï¼š
- **å­˜å‚¨ vs ä½¿ç”¨**ï¼š`output_dict`ä¿å­˜æ‰€æœ‰å†å²å¸§ï¼ˆæ”¯æŒåŒå‘è·Ÿè¸ªå’Œäº¤äº’ï¼‰ï¼Œä½†æ¯æ¬¡æ¨ç†åªä½¿ç”¨7å¸§
- **å›ºå®šä½¿ç”¨å®¹é‡**ï¼šæ— è®ºè§†é¢‘å¤šé•¿ï¼ŒMemory Attentionå§‹ç»ˆåªä½¿ç”¨7å¸§è¿›è¡Œè®¡ç®—
- **æ™ºèƒ½é€‰æ‹©**ï¼šSAMURAIä»æ‰€æœ‰å†å²å¸§ä¸­é€šè¿‡è´¨é‡è¿‡æ»¤é€‰æ‹©æœ€ä¼˜çš„7å¸§

### 1.2 å­˜å‚¨å†…å®¹

æ¯ä¸ªå¸§åœ¨Memory Bankä¸­å­˜å‚¨ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š

| å­—æ®µå | ç±»å‹ | æè¿° | SAMURAIç‰¹æœ‰ |
|--------|------|------|-------------|
| `maskmem_features` | `torch.Tensor` | ç¼–ç åçš„è®°å¿†ç‰¹å¾ï¼ˆèåˆè§†è§‰ç‰¹å¾å’Œæ©ç ï¼‰ | âŒ |
| `maskmem_pos_enc` | `torch.Tensor` | ç©ºé—´ä½ç½®ç¼–ç  | âŒ |
| `obj_ptr` | `torch.Tensor` | ç›®æ ‡æŒ‡é’ˆï¼ˆç”¨äºè·¨å¸§æ³¨æ„åŠ›ï¼‰ | âŒ |
| `best_iou_score` | `torch.Tensor` | æ©ç è´¨é‡åˆ†æ•° | âœ… |
| `object_score_logits` | `torch.Tensor` | ç›®æ ‡å­˜åœ¨ç½®ä¿¡åº¦ | âŒ |
| `kf_score` | `torch.Tensor` | å¡å°”æ›¼æ»¤æ³¢ä¸€è‡´æ€§åˆ†æ•° | âœ… |

---

## ğŸ”§ äºŒã€Memory Bankçš„ç¼–ç è¿‡ç¨‹

### 2.1 æ•´ä½“ç¼–ç æµç¨‹

å½“æ¯ä¸€å¸§è¢«å¤„ç†åï¼Œéœ€è¦å°†é¢„æµ‹çš„æ©ç ç¼–ç æˆè®°å¿†ç‰¹å¾ï¼š

```python
def _encode_new_memory(
    self,
    current_vision_feats,     # å½“å‰å¸§çš„è§†è§‰ç‰¹å¾
    feat_sizes,               # ç‰¹å¾å›¾å°ºå¯¸
    pred_masks_high_res,      # é¢„æµ‹çš„é«˜åˆ†è¾¨ç‡æ©ç 
    object_score_logits,      # ç›®æ ‡å­˜åœ¨åˆ†æ•°
    is_mask_from_pts,         # æ˜¯å¦æ¥è‡ªç‚¹å‡»æ ‡æ³¨
):
    """å°†å½“å‰å›¾åƒå’Œé¢„æµ‹ç»“æœç¼–ç ä¸ºè®°å¿†ç‰¹å¾"""
```

**ç¼–ç æ­¥éª¤**ï¼š

1. **æå–è§†è§‰ç‰¹å¾**ï¼šä»backboneçš„æœ€é«˜å±‚ç‰¹å¾ï¼ˆlowest-resolutionï¼‰æå–
2. **å¤„ç†æ©ç **ï¼šå¯¹é¢„æµ‹çš„æ©ç åº”ç”¨sigmoid + ç¼©æ”¾ + åç§»  
3. **æ©ç ä¸‹é‡‡æ ·**ï¼šé€šè¿‡`MaskDownSampler`å°†æ©ç ä¸‹é‡‡æ ·åˆ°ä¸ç‰¹å¾ç›¸åŒçš„å°ºå¯¸
4. **ç‰¹å¾èåˆ**ï¼šå°†è§†è§‰ç‰¹å¾å’Œä¸‹é‡‡æ ·çš„æ©ç èåˆ

### 2.2 MemoryEncoderçš„å†…éƒ¨å®ç°

```python
class MemoryEncoder(nn.Module):
    def forward(self, pix_feat: torch.Tensor, masks: torch.Tensor):
        # 1. å¤„ç†æ©ç  - åº”ç”¨sigmoidå¹¶ä¸‹é‡‡æ ·
        masks = F.sigmoid(masks)
        masks = self.mask_downsampler(masks)  # 1024Ã—1024 â†’ 64Ã—64
        
        # 2. ç‰¹å¾èåˆ - æ©ç ä½œä¸ºæ®‹å·®åŠ åˆ°ç‰¹å¾ä¸Š
        x = self.pix_feat_proj(pix_feat)
        x = x + masks  # å…³é”®ï¼šè§†è§‰ç‰¹å¾ + æ©ç ä¿¡æ¯
        
        # 3. è¿›ä¸€æ­¥èåˆ - é€šè¿‡ConvNeXt blocks
        x = self.fuser(x)
        x = self.out_proj(x)
        
        # 4. ç”Ÿæˆä½ç½®ç¼–ç 
        pos = self.position_encoding(x)
        
        return {
            "vision_features": x, 
            "vision_pos_enc": [pos]
        }
```

**å…³é”®è®¾è®¡æ€æƒ³**ï¼š
- **æ©ç ä¸‹é‡‡æ ·**ï¼šå°†é«˜åˆ†è¾¨ç‡æ©ç ï¼ˆå¦‚1024Ã—1024ï¼‰ä¸‹é‡‡æ ·åˆ°ä¸ç‰¹å¾å›¾ç›¸åŒçš„å°ºå¯¸ï¼ˆå¦‚64Ã—64ï¼‰
- **æ®‹å·®èåˆ**ï¼šæ©ç ä¿¡æ¯ä½œä¸ºæ®‹å·®ç›´æ¥åŠ åˆ°è§†è§‰ç‰¹å¾ä¸Šï¼Œè®©æ¨¡å‹æ˜ç¡®çŸ¥é“"å“ªé‡Œæœ‰ç›®æ ‡"
- **ConvNeXtèåˆ**ï¼šé€šè¿‡æ·±åº¦å·ç§¯è¿›ä¸€æ­¥èåˆå¤šæ¨¡æ€ä¿¡æ¯

---

## ğŸ¯ ä¸‰ã€Memory Bankçš„é€‰æ‹©ç­–ç•¥

è¿™æ˜¯**SAMURAI vs åŸå§‹SAM 2æœ€æ ¸å¿ƒçš„åŒºåˆ«**ï¼

**âš ï¸ å¸¸è§è¯¯è§£æ¾„æ¸…**ï¼š

| è¯¯è§£ | äº‹å® |
|------|------|
| âŒ SAMURAIåªä¿å­˜7å¸§ï¼Œåˆ é™¤å…¶ä»–å†å²å¸§ | âœ… `output_dict`ä¿å­˜æ‰€æœ‰å†å²å¸§ï¼ˆoffloadåˆ°CPUï¼‰ï¼Œæ¯æ¬¡**ä½¿ç”¨**7å¸§ |
| âŒ Memory Bankä¼šéšè§†é¢‘é•¿åº¦æ— é™å¢é•¿ | âœ… GPU Memory Bankå›ºå®š7å¸§ï¼Œä½†CPUä¿ç•™å®Œæ•´å†å²ç”¨äºäº¤äº’ |
| âŒ SAMURAIå†…å­˜å ç”¨æ¯”SAM 2å¤§ | âœ… GPUå ç”¨ç›¸åŒï¼ˆ7å¸§ï¼‰ï¼ŒCPUå ç”¨ç•¥å¤šä½†å¯æ§ï¼ˆoffloadæœºåˆ¶ï¼‰ |
| âŒ "æ‰«æå†å²å¸§"éœ€è¦éå†æ‰€æœ‰å¸§ | âœ… æœ€å¤šæ‰«æ15å¸§å³åœæ­¢ï¼ˆ`max_obj_ptrs_in_encoder - 1`ï¼‰ |
| âŒ `valid_indices`å°±æ˜¯Memory Bank | âœ… `valid_indices`æ˜¯å€™é€‰æ± ï¼ˆæœ€å¤š15å¸§ï¼‰ï¼Œä»ä¸­é€‰6å¸§ç»„æˆMemory Bank |

### 3.1 åŸå§‹SAM 2ç­–ç•¥ï¼šå›ºå®šæ—¶é—´é—´éš”é‡‡æ ·

```python
# åŸå§‹SAM 2çš„é€‰æ‹©é€»è¾‘
for t_pos in range(1, self.num_maskmem):
    t_rel = self.num_maskmem - t_pos  # è·ç¦»å½“å‰å¸§çš„å¸§æ•°
    
    if t_rel == 1:
        # æ€»æ˜¯é€‰æ‹©å‰ä¸€å¸§ (frame_idx - 1)
        prev_frame_idx = frame_idx - t_rel
    else:
        # æ¯éš”strideå¸§é€‰æ‹©ä¸€å¸§
        prev_frame_idx = ((frame_idx - 2) // stride) * stride
        prev_frame_idx = prev_frame_idx - (t_rel - 2) * stride
```

**åŸå§‹ç­–ç•¥ç‰¹ç‚¹**ï¼š
- âœ… **ç®€å•é«˜æ•ˆ**ï¼šæ—¶é—´å¤æ‚åº¦O(1)ï¼Œè®¡ç®—é‡å°
- âœ… **æ—¶é—´å‡åŒ€**ï¼šä¿è¯æ—¶é—´è·¨åº¦çš„å‡åŒ€è¦†ç›–
- âŒ **å¿½ç•¥è´¨é‡**ï¼šä¸è€ƒè™‘å¸§çš„è´¨é‡ï¼Œå¯èƒ½é€‰åˆ°é®æŒ¡/æ¨¡ç³Šå¸§
- âŒ **å›ºå®šæ¨¡å¼**ï¼šæ— æ³•æ ¹æ®è§†é¢‘å†…å®¹è‡ªé€‚åº”è°ƒæ•´

**ç¤ºä¾‹**ï¼ˆå½“å‰å¸§=10ï¼Œstride=1ï¼Œnum_maskmem=7ï¼‰ï¼š
```
é€‰æ‹©å¸§: [9, 8, 7, 6, 5, 4]
```

### 3.2 SAMURAIç­–ç•¥ï¼šè´¨é‡é©±åŠ¨çš„æ™ºèƒ½é€‰æ‹©

**ğŸ”‘ ä¸‰å±‚æ¶æ„ç†è§£**ï¼š

SAMURAIçš„Memory Banké€‰æ‹©æœºåˆ¶åŒ…å«ä¸‰ä¸ªå±‚æ¬¡ï¼š

```
ğŸ“Š å®Œæ•´çš„Memory Banké€‰æ‹©æµç¨‹ï¼š

ç¬¬1å±‚ï¼šoutput_dict["non_cond_frame_outputs"]
       â””â”€ æ‰€æœ‰è·Ÿè¸ªè¿‡çš„å†å²å¸§ï¼ˆå¯èƒ½å‡ ç™¾ä¸Šåƒå¸§ï¼Œå­˜å‚¨åœ¨CPUï¼‰
       â””â”€ ç”¨é€”ï¼šå®Œæ•´å†å²è®°å½•ï¼Œæ”¯æŒåŒå‘è·Ÿè¸ªå’Œç”¨æˆ·äº¤äº’
       
ç¬¬2å±‚ï¼švalid_indicesï¼ˆé«˜è´¨é‡å¸§å€™é€‰æ± ï¼‰
       â””â”€ é€šè¿‡ä¸‰é‡è´¨é‡æ£€æŸ¥çš„å¸§ï¼ˆæœ€å¤š15å¸§ï¼‰
       â””â”€ ç”¨é€”ï¼šè´¨é‡è¿‡æ»¤åçš„å€™é€‰é›†
       
ç¬¬3å±‚ï¼šMemory Bankï¼ˆçœŸæ­£ç”¨äºæ¨ç†çš„å¸§ï¼‰
       â””â”€ ä»valid_indicesä¸­é€‰æ‹©æœ€è¿‘çš„6ä¸ª + 1ä¸ªconditioning frame = 7å¸§
       â””â”€ ç”¨é€”ï¼šMemory Attentionè®¡ç®—
```

**é€‰æ‹©ä»£ç è¯¦è§£**ï¼š

```python
if self.samurai_mode:
    # æ­¥éª¤1ï¼šæ„å»ºé«˜è´¨é‡å¸§å€™é€‰æ± ï¼ˆvalid_indicesï¼‰
    valid_indices = [] 
    
    # ä»output_dictä¸­æ‰«æå†å²å¸§ï¼ˆæ³¨æ„ï¼šè¿™é‡ŒåŒ…å«æ‰€æœ‰è·Ÿè¸ªè¿‡çš„å¸§ï¼‰
    for i in range(frame_idx - 1, 1, -1):
        if i not in output_dict["non_cond_frame_outputs"]:
            continue  # è·³è¿‡ä¸å­˜åœ¨çš„å¸§ç´¢å¼•
            
        # è·å–ä¸‰é‡è´¨é‡æŒ‡æ ‡
        iou_score = output_dict["non_cond_frame_outputs"][i]["best_iou_score"]
        obj_score = output_dict["non_cond_frame_outputs"][i]["object_score_logits"]  
        kf_score = output_dict["non_cond_frame_outputs"][i].get("kf_score", None)
        
        # ä¸‰é‡è´¨é‡è¿‡æ»¤æ¡ä»¶
        if (iou_score.item() > self.memory_bank_iou_threshold and 
            obj_score.item() > self.memory_bank_obj_score_threshold and 
            (kf_score is None or kf_score.item() > self.memory_bank_kf_score_threshold)):
            
            valid_indices.insert(0, i)  # æ’å…¥åˆ°å¼€å¤´ï¼Œä¿æŒæ—¶é—´é¡ºåº
            
        # å®¹é‡é™åˆ¶ï¼šæœ€å¤šä¿ç•™15ä¸ªé«˜è´¨é‡å€™é€‰å¸§
        if len(valid_indices) >= self.max_obj_ptrs_in_encoder - 1:  # 16 - 1 = 15
            break
    
    # ä¿è¯åŒ…å«æœ€è¿‘ä¸€å¸§ï¼ˆå³ä½¿è´¨é‡ä¸é«˜ï¼Œé˜²æ­¢æ—¶é—´æ–­å±‚ï¼‰
    if frame_idx - 1 not in valid_indices:
        valid_indices.append(frame_idx - 1)
    
    # æ­¥éª¤2ï¼šä»valid_indicesä¸­é€‰æ‹©æœ€è¿‘çš„6ä¸ªå¸§ç”¨äºMemory Bank
    for t_pos in range(1, self.num_maskmem):  # num_maskmem=7, å¾ªç¯6æ¬¡
        idx = t_pos - self.num_maskmem  # idx: -6, -5, -4, -3, -2, -1
        if idx < -len(valid_indices):  # å¦‚æœvalid_indicesä¸è¶³6ä¸ªï¼Œè·³è¿‡
            continue
        # ä½¿ç”¨è´Ÿç´¢å¼•ä»valid_indicesåå¾€å‰å–
        out = output_dict["non_cond_frame_outputs"].get(valid_indices[idx], None)
        if out is None:
            out = unselected_cond_outputs.get(valid_indices[idx], None)
        t_pos_and_prevs.append((t_pos, out))
```

### 3.3 ä¸‰é‡è´¨é‡è¯„ä¼°æ ‡å‡†

SAMURAIå¼•å…¥äº†ä¸‰ä¸ªè´¨é‡æŒ‡æ ‡æ¥è¯„ä¼°æ¯ä¸ªå†å²å¸§ï¼š

#### 1. **æ©ç ä¸€è‡´æ€§åˆ†æ•°** (`best_iou_score`)
- **è®¡ç®—æ–¹å¼**ï¼šå½“å‰å¸§å¤šæ©ç å€™é€‰ä¸å†å²å¸§æ©ç çš„æœ€å¤§IoU
- **é˜ˆå€¼**ï¼š`memory_bank_iou_threshold = 0.5`  
- **å«ä¹‰**ï¼šè¡¡é‡æ©ç é¢„æµ‹çš„ç¨³å®šæ€§å’Œå‡†ç¡®æ€§
- **è¿‡æ»¤ç›®æ ‡**ï¼šæ’é™¤æ©ç è´¨é‡å·®ã€é¢„æµ‹ä¸ç¨³å®šçš„å¸§

#### 2. **ç›®æ ‡å­˜åœ¨ç½®ä¿¡åº¦** (`object_score_logits`)  
- **è®¡ç®—æ–¹å¼**ï¼šSAM decoderé¢„æµ‹çš„ç›®æ ‡å­˜åœ¨æ¦‚ç‡
- **é˜ˆå€¼**ï¼š`memory_bank_obj_score_threshold = 0.0`
- **å«ä¹‰**ï¼šåˆ¤æ–­ç›®æ ‡æ˜¯å¦çœŸå®å­˜åœ¨äºè¯¥å¸§ä¸­
- **è¿‡æ»¤ç›®æ ‡**ï¼šæ’é™¤ç›®æ ‡å·²æ¶ˆå¤±æˆ–ä¸¥é‡é®æŒ¡çš„å¸§

#### 3. **è¿åŠ¨ä¸€è‡´æ€§åˆ†æ•°** (`kf_score`)
- **è®¡ç®—æ–¹å¼**ï¼šå¡å°”æ›¼æ»¤æ³¢å™¨é¢„æµ‹çš„è¿åŠ¨ä¸€è‡´æ€§
- **é˜ˆå€¼**ï¼š`memory_bank_kf_score_threshold = 0.0` 
- **å«ä¹‰**ï¼šéªŒè¯ç›®æ ‡è¿åŠ¨çš„åˆç†æ€§å’Œè¿ç»­æ€§
- **è¿‡æ»¤ç›®æ ‡**ï¼šæ’é™¤è¿åŠ¨å¼‚å¸¸ã€çªå˜çš„å¸§

### 3.4 é€‰æ‹©ç­–ç•¥å¯¹æ¯”ç¤ºä¾‹

**åœºæ™¯**ï¼šå½“å‰è·Ÿè¸ªåˆ°å¸§100ï¼Œè´¨é‡é˜ˆå€¼=0.5ï¼Œè¿‡å»10å¸§çš„è´¨é‡åˆ†æ•°ï¼š

| å¸§å· | 99 | 98 | 97 | 96 | 95 | 94 | 93 | 92 | 91 | 90 |
|-----|----|----|----|----|----|----|----|----|----|----|
| IoU Score | 0.9 | 0.3 | 0.8 | 0.2 | 0.7 | 0.6 | 0.1 | 0.8 | 0.9 | 0.5 |
| è´¨é‡è¯„ä¼° | âœ… | âŒ | âœ… | âŒ | âœ… | âœ… | âŒ | âœ… | âœ… | âœ… |

**SAMURAIä¸‰å±‚é€‰æ‹©æµç¨‹**ï¼š

```
ç¬¬1å±‚ï¼šoutput_dict["non_cond_frame_outputs"]
â”œâ”€ åŒ…å«ï¼š[1, 2, 3, ..., 90, 91, 92, 93, 94, 95, 96, 97, 98, 99]
â””â”€ è¯´æ˜ï¼šæ‰€æœ‰è·Ÿè¸ªè¿‡çš„å†å²å¸§ï¼ˆå­˜å‚¨åœ¨CPUï¼‰

ç¬¬2å±‚ï¼švalid_indicesï¼ˆè´¨é‡è¿‡æ»¤åï¼‰
â”œâ”€ æ‰«æèŒƒå›´ï¼šä»å¸§99å¾€å‰æ‰«æï¼Œæœ€å¤šæ‰«æ15å¸§
â”œâ”€ è´¨é‡è¿‡æ»¤ï¼šIoU > 0.5
â”œâ”€ ç»“æœï¼š[90, 91, 92, 94, 95, 97, 99]  â† 7ä¸ªé«˜è´¨é‡å¸§
â””â”€ è¯´æ˜ï¼šé€šè¿‡ä¸‰é‡è´¨é‡æ£€æŸ¥çš„å€™é€‰å¸§

ç¬¬3å±‚ï¼šMemory Bankï¼ˆå®é™…ä½¿ç”¨ï¼‰
â”œâ”€ é€‰æ‹©ç­–ç•¥ï¼šä»valid_indiceså–æœ€è¿‘çš„6ä¸ª
â”œâ”€ valid_indices[-6:] = [91, 92, 94, 95, 97, 99]
â”œâ”€ åŠ ä¸Šconditioning frame (å¸§0)
â””â”€ æœ€ç»ˆMemory Bank = [frame_0, 91, 92, 94, 95, 97, 99]  â† 7å¸§
```

**é€‰æ‹©ç»“æœå¯¹æ¯”**ï¼š

```mermaid
graph LR
    subgraph "åŸå§‹SAM 2ï¼ˆå›ºå®šé—´éš”ï¼‰"
        A[99] --> B[98âŒ]
        B --> C[97]  
        C --> D[96âŒ]
        D --> E[95]
        E --> F[94]
    end
    
    subgraph "SAMURAIï¼ˆè´¨é‡é©±åŠ¨ï¼‰"
        G[99] --> H[97]
        H --> I[95]
        I --> J[94] 
        J --> K[92]
        K --> L[91]
    end
```

- **SAM 2é€‰æ‹©**ï¼š[99, 98, 97, 96, 95, 94] - åŒ…å«2ä¸ªä½è´¨é‡å¸§
- **SAMURAIé€‰æ‹©**ï¼š[99, 97, 95, 94, 92, 91] - å…¨éƒ¨é«˜è´¨é‡å¸§

**SAMURAIä¼˜åŠ¿**ï¼š
- âœ… **è´¨é‡ä¿è¯**ï¼šåªä¿ç•™é«˜è´¨é‡å¸§ï¼Œé¿å…é”™è¯¯ç´¯ç§¯
- âœ… **è‡ªé€‚åº”æ€§**ï¼šæ ¹æ®è§†é¢‘å†…å®¹åŠ¨æ€è°ƒæ•´
- âœ… **è¿åŠ¨æ„ŸçŸ¥**ï¼šè€ƒè™‘ç›®æ ‡è¿åŠ¨çš„è¿ç»­æ€§
- âœ… **é²æ£’æ€§**ï¼šå¯¹é®æŒ¡ã€æ¨¡ç³Šã€å¿«é€Ÿè¿åŠ¨æ›´é²æ£’

---

## ğŸ”„ å››ã€Memory Bankçš„ä½¿ç”¨è¿‡ç¨‹

### 4.1 å‡†å¤‡è®°å¿†æ¡ä»¶ç‰¹å¾

å½“è·Ÿè¸ªå½“å‰å¸§æ—¶ï¼Œéœ€è¦ä»Memory Bankä¸­æå–ç›¸å…³è®°å¿†ï¼š

```python
def _prepare_memory_conditioned_features(
    self,
    frame_idx,              # å½“å‰å¸§ç´¢å¼•
    is_init_cond_frame,     # æ˜¯å¦ä¸ºåˆå§‹æ ‡æ³¨å¸§
    current_vision_feats,   # å½“å‰å¸§è§†è§‰ç‰¹å¾
    current_vision_pos_embeds, # å½“å‰å¸§ä½ç½®ç¼–ç 
    feat_sizes,            # ç‰¹å¾å›¾å°ºå¯¸
    output_dict,           # å†å²å¸§è¾“å‡ºå­—å…¸
    num_frames,            # æ€»å¸§æ•°
    track_in_reverse=False # æ˜¯å¦åå‘è·Ÿè¸ª
):
```

### 4.2 æ„å»ºè®°å¿†å¼ é‡

é€‰å®šè®°å¿†å¸§åï¼Œéœ€è¦å°†å®ƒä»¬ç»„ç»‡æˆæ¨¡å‹å¯ä»¥ä½¿ç”¨çš„å¼ é‡æ ¼å¼ï¼š

```python
# æå–è®°å¿†ç‰¹å¾å’Œä½ç½®ç¼–ç 
for t_pos, prev in t_pos_and_prevs:
    if prev is None:
        continue  # è·³è¿‡å¡«å……å¸§
    
    # 1. æå–è®°å¿†ç‰¹å¾ (å¯èƒ½åœ¨CPUä¸Šï¼Œéœ€è¦ç§»å›GPU)
    feats = prev["maskmem_features"].to(device, non_blocking=True)
    to_cat_memory.append(feats.flatten(2).permute(2, 0, 1))  # HWÃ—BÃ—C
    
    # 2. ç©ºé—´ä½ç½®ç¼–ç 
    maskmem_enc = prev["maskmem_pos_enc"][-1].to(device)
    maskmem_enc = maskmem_enc.flatten(2).permute(2, 0, 1)
    
    # 3. æ·»åŠ æ—¶é—´ä½ç½®ç¼–ç  (è®©æ¨¡å‹çŸ¥é“è¿™æ˜¯"å‡ å¸§å‰"çš„è®°å¿†)
    temporal_pos_enc = self.maskmem_tpos_enc[self.num_maskmem - t_pos - 1]
    maskmem_enc = maskmem_enc + temporal_pos_enc
    
    to_cat_memory_pos_embed.append(maskmem_enc)
```

**å…³é”®è®¾è®¡**ï¼š
- **ç©ºé—´ç¼–ç **ï¼šå‘Šè¯‰æ¨¡å‹è®°å¿†ç‰¹å¾åœ¨å›¾åƒä¸­çš„ä½ç½®
- **æ—¶é—´ç¼–ç **ï¼šå‘Šè¯‰æ¨¡å‹è¿™æ˜¯è·ç¦»å½“å‰å¸§å¤šè¿œçš„è®°å¿†
- **ç‰¹å¾é‡æ’**ï¼šä»`[B, C, H, W]`è½¬æ¢ä¸ºTransformeréœ€è¦çš„`[HW, B, C]`æ ¼å¼

### 4.3 é€šè¿‡Memory Attentionèåˆè®°å¿†

```python
# æ‹¼æ¥æ‰€æœ‰è®°å¿†ç‰¹å¾
memory = torch.cat(to_cat_memory, dim=0)          # [total_memory_len, B, C]
memory_pos_embed = torch.cat(to_cat_memory_pos_embed, dim=0)

# é€šè¿‡Memory Attentionèåˆå½“å‰å¸§ç‰¹å¾å’Œå†å²è®°å¿†
pix_feat_with_mem = self.memory_attention(
    curr=current_vision_feats,        # å½“å‰å¸§ç‰¹å¾ (query)
    curr_pos=current_vision_pos_embeds, # å½“å‰å¸§ä½ç½®ç¼–ç 
    memory=memory,                    # å†å²è®°å¿†ç‰¹å¾ (key, value)  
    memory_pos=memory_pos_embed,      # è®°å¿†ä½ç½®ç¼–ç 
)
```

### 4.4 Memory Attentionçš„å†…éƒ¨æœºåˆ¶

Memory Attentionæ˜¯ä¸€ä¸ªä¸“é—¨è®¾è®¡çš„Transformer Encoderï¼ŒåŒ…å«ä¸‰ä¸ªå…³é”®æ“ä½œï¼š

```python
class MemoryAttentionLayer(nn.Module):
    def forward(self, tgt, memory, pos=None, query_pos=None):
        # 1. Self-Attentionï¼šå½“å‰å¸§ç‰¹å¾çš„å†…éƒ¨äº¤äº’
        tgt = self._forward_sa(tgt, query_pos)
        
        # 2. Cross-Attentionï¼šå½“å‰å¸§ cross-attend to å†å²è®°å¿†  
        tgt = self._forward_ca(tgt, memory, query_pos, pos)
        
        # 3. FFNï¼šå‰é¦ˆç½‘ç»œè¿›ä¸€æ­¥å¤„ç†
        tgt2 = self.norm3(tgt)
        tgt2 = self.linear2(self.dropout(self.activation(self.linear1(tgt2))))
        tgt = tgt + self.dropout3(tgt2)
        
        return tgt
```

**æ³¨æ„åŠ›æœºåˆ¶è¯¦è§£**ï¼š

1. **Self-Attention**ï¼š
   - `Q = K = V = current_features + pos_encoding`
   - è®©å½“å‰å¸§çš„ä¸åŒä½ç½®ç‰¹å¾ç›¸äº’äº¤äº’

2. **Cross-Attention**ï¼š  
   - `Q = current_features + current_pos`
   - `K = V = memory_features + memory_pos`
   - è®©å½“å‰å¸§ç‰¹å¾æŸ¥è¯¢å†å²è®°å¿†ä¸­çš„ç›¸å…³ä¿¡æ¯

3. **ä½ç½®ç¼–ç çš„ä½œç”¨**ï¼š
   - **ç©ºé—´ä½ç½®ç¼–ç **ï¼šåŒºåˆ†ä¸åŒçš„å›¾åƒä½ç½®
   - **æ—¶é—´ä½ç½®ç¼–ç **ï¼šåŒºåˆ†ä¸åŒæ—¶é—´çš„è®°å¿†

---

## ğŸ“Š äº”ã€å®Œæ•´çš„Memory Bankç”Ÿå‘½å‘¨æœŸ

### é˜¶æ®µ1ï¼šåˆå§‹åŒ–ï¼ˆç¬¬0å¸§ï¼‰

```python
# ç”¨æˆ·åœ¨ç¬¬0å¸§æ ‡æ³¨ç›®æ ‡è¾¹ç•Œæ¡†
predictor.add_new_points_or_box(
    state, 
    box=[x1, y1, x2, y2], 
    frame_idx=0, 
    obj_id=0
)

# ç³»ç»Ÿè‡ªåŠ¨ç¼–ç ç¬¬0å¸§åˆ°Memory Bank
# output_dict["cond_frame_outputs"][0] = {
#     "maskmem_features": encoded_features,    # ç¼–ç åçš„è§†è§‰+æ©ç ç‰¹å¾
#     "maskmem_pos_enc": spatial_pos_enc,     # ç©ºé—´ä½ç½®ç¼–ç   
#     "obj_ptr": object_pointer,              # ç›®æ ‡æŒ‡é’ˆ
#     # æ³¨ï¼šconditioning frameæ²¡æœ‰è´¨é‡åˆ†æ•°ï¼Œå› ä¸ºå®ƒæ˜¯ground truth
# }
```

### é˜¶æ®µ2ï¼šé€å¸§è·Ÿè¸ª

```python
for frame_idx in range(1, num_frames):
    # Step 1: ä»Memory Banké€‰æ‹©å†å²å¸§
    if samurai_mode:
        selected_frames = select_high_quality_frames(frame_idx, output_dict)
    else:
        selected_frames = select_uniform_temporal_frames(frame_idx)
    
    # Step 2: é€šè¿‡Memory Attentionèåˆå†å²è®°å¿†
    current_feat_with_mem = memory_attention(
        current_feat, 
        selected_memory_features
    )
    
    # Step 3: ä½¿ç”¨SAM Decoderé¢„æµ‹å½“å‰å¸§æ©ç 
    masks, iou_scores = sam_decoder(current_feat_with_mem)
    
    # Step 4: å¤šæ©ç é€‰æ‹©ï¼ˆSAMURAIç‰¹æœ‰çš„å¡å°”æ›¼æ»¤æ³¢å¢å¼ºï¼‰
    if samurai_mode:
        best_mask = kalman_enhanced_mask_selection(masks, iou_scores)
    else:
        best_mask = select_best_mask_by_iou(masks, iou_scores)
    
    # Step 5: ç¼–ç å½“å‰å¸§åˆ°Memory Bank
    maskmem = memory_encoder(current_feat, best_mask)
    output_dict["non_cond_frame_outputs"][frame_idx] = {
        "maskmem_features": maskmem["vision_features"],
        "maskmem_pos_enc": maskmem["vision_pos_enc"], 
        "obj_ptr": object_pointer,
        "best_iou_score": best_iou_score,      # SAMURAIè´¨é‡æŒ‡æ ‡
        "object_score_logits": obj_confidence, # ç›®æ ‡å­˜åœ¨ç½®ä¿¡åº¦
        "kf_score": kalman_consistency_score,  # SAMURAIè¿åŠ¨ä¸€è‡´æ€§
    }
```

### é˜¶æ®µ3ï¼šå†…å­˜ç®¡ç†ä¸ä¼˜åŒ–

**ğŸ”‘ é‡è¦æ¾„æ¸…**ï¼šSAMURAIé‡‡ç”¨**å®Œæ•´å­˜å‚¨+æ™ºèƒ½é€‰æ‹©**æœºåˆ¶ã€‚

```python
# å®é™…çš„SAMURAIå†…å­˜ç®¡ç†æœºåˆ¶
class SAMURAIMemoryManagement:
    def __init__(self):
        # output_dict: ä¿å­˜æ‰€æœ‰å†å²å¸§ï¼ˆæ”¯æŒåŒå‘è·Ÿè¸ªå’Œäº¤äº’ï¼‰
        self.output_dict = {
            "cond_frame_outputs": {},      # conditioning frames
            "non_cond_frame_outputs": {}   # æ‰€æœ‰è·Ÿè¸ªè¿‡çš„non-conditioning frames
        }
        self.num_maskmem = 7  # æ¯æ¬¡ä½¿ç”¨çš„å¸§æ•°
        self.max_obj_ptrs_in_encoder = 16  # valid_indicesæœ€å¤§é•¿åº¦
    
    def add_new_frame(self, frame_idx, frame_output):
        """æ·»åŠ æ–°å¸§åˆ°output_dictï¼ˆä¿ç•™æ‰€æœ‰å†å²ï¼‰"""
        # 1. ç¼–ç å½“å‰å¸§å¹¶ä¿å­˜
        self.output_dict["non_cond_frame_outputs"][frame_idx] = frame_output
        
        # 2. å†…å­˜ä¼˜åŒ–ï¼šoffloadåˆ°CPU
        if self.offload_state_to_cpu:
            frame_output["maskmem_features"] = frame_output["maskmem_features"].cpu()
            frame_output["pred_masks"] = frame_output["pred_masks"].cpu()
    
    def select_frames_for_tracking(self, frame_idx):
        """æ¯æ¬¡è·Ÿè¸ªæ—¶ä»æ‰€æœ‰å†å²å¸§ä¸­æ™ºèƒ½é€‰æ‹©7å¸§"""
        # æ­¥éª¤1ï¼šè´¨é‡è¿‡æ»¤ï¼Œæ„å»ºvalid_indicesï¼ˆæœ€å¤š15å¸§ï¼‰
        valid_indices = []
        for i in range(frame_idx - 1, max(1, frame_idx - 100), -1):
            if i in self.output_dict["non_cond_frame_outputs"]:
                if self.check_quality(i):  # ä¸‰é‡è´¨é‡æ£€æŸ¥
                    valid_indices.insert(0, i)
                    if len(valid_indices) >= 15:
                        break
        
        # æ­¥éª¤2ï¼šä»valid_indicesé€‰æ‹©æœ€è¿‘çš„6å¸§
        selected_frames = []
        for t_pos in range(1, 7):  # é€‰6ä¸ª
            idx = t_pos - 7  # -6, -5, -4, -3, -2, -1
            if idx >= -len(valid_indices):
                selected_frames.append(valid_indices[idx])
        
        # æ­¥éª¤3ï¼šç»„æˆMemory Bankï¼ˆ1ä¸ªcond + 6ä¸ªnon-cond = 7å¸§ï¼‰
        memory_bank = [self.conditioning_frame] + selected_frames
        return memory_bank
```

**å…³é”®ç†è§£**ï¼š
- **å­˜å‚¨ç­–ç•¥**ï¼šä¿ç•™æ‰€æœ‰å†å²å¸§åœ¨`output_dict`ï¼ˆoffloadåˆ°CPUèŠ‚çœGPUå†…å­˜ï¼‰
- **ä½¿ç”¨ç­–ç•¥**ï¼šæ¯æ¬¡åªä½¿ç”¨7å¸§è¿›è¡ŒMemory Attentionè®¡ç®—
- **å†…å­˜å ç”¨**ï¼šGPUå†…å­˜å›ºå®šï¼ˆ7å¸§ï¼‰ï¼ŒCPUå†…å­˜å¢é•¿ï¼ˆä½†å¯æ§ï¼‰
- **è®¾è®¡ç›®çš„**ï¼šæ”¯æŒåŒå‘è·Ÿè¸ªã€ç”¨æˆ·äº¤äº’ä¿®æ­£ã€çµæ´»çš„å¸§é€‰æ‹©

**ç»´æŠ¤ç­–ç•¥å¯¹æ¯”**ï¼š

| ç»´æŠ¤æ–¹å¼ | SAM 2 | SAMURAI |
|---------|--------|---------|
| **å†å²å¸§å­˜å‚¨** | ä¿å­˜æ‰€æœ‰å†å²å¸§ï¼ˆCPUï¼‰ | ä¿å­˜æ‰€æœ‰å†å²å¸§ï¼ˆCPUï¼‰âœ… ç›¸åŒ |
| **Memory Bankä½¿ç”¨** | å›ºå®šä½¿ç”¨7å¸§ | å›ºå®šä½¿ç”¨7å¸§ âœ… ç›¸åŒ |
| **å¸§é€‰æ‹©ç­–ç•¥** | å›ºå®šæ—¶é—´é—´éš”é‡‡æ · | ä¸‰å±‚è´¨é‡é©±åŠ¨é€‰æ‹© ğŸ”„ åˆ›æ–° |
| **GPUå†…å­˜å ç”¨** | 7å¸§ï¼ˆæ’å®šï¼‰ | 7å¸§ï¼ˆæ’å®šï¼‰âœ… ç›¸åŒ |
| **CPUå†…å­˜å ç”¨** | æ‰€æœ‰å†å²å¸§ | æ‰€æœ‰å†å²å¸§ âœ… ç›¸åŒ |
| **é€‚åº”èƒ½åŠ›** | æ—¶é—´å‡åŒ€ï¼Œå†…å®¹ç›²ç›® | å†…å®¹æ„ŸçŸ¥ï¼Œè´¨é‡ä¼˜å…ˆ ğŸ”„ åˆ›æ–° |

**å…³é”®ç†è§£**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯¯è§£ï¼šSAMURAIåªä¿å­˜7å¸§                                       â”‚
â”‚  äº‹å®ï¼šSAMURAIä¿å­˜æ‰€æœ‰å†å²å¸§ï¼Œä½†æ¯æ¬¡åªç”¨7å¸§                    â”‚
â”‚                                                              â”‚
â”‚  output_dictå­˜å‚¨          valid_indicesè¿‡æ»¤     Memory Bank  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ å¸§1~99      â”‚  è´¨é‡è¿‡æ»¤ â”‚ é«˜è´¨é‡å¸§  â”‚  é€‰æœ€è¿‘6ä¸ª â”‚ 7å¸§  â”‚     â”‚
â”‚  â”‚ (CPUä¿å­˜)   â”‚ â”€â”€â”€â”€â”€â”€â”€> â”‚ (æœ€å¤š15) â”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚(GPU) â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚   æ‰€æœ‰å†å²å¸§               å€™é€‰æ±                 å®é™…ä½¿ç”¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡æ™ºæ…§**ï¼š
- âœ… **ä¿ç•™å®Œæ•´å†å²**ï¼šæ”¯æŒåŒå‘è·Ÿè¸ªå’Œç”¨æˆ·äº¤äº’
- âœ… **å›ºå®šä½¿ç”¨å®¹é‡**ï¼šä¿æŒGPUå†…å­˜å’Œè®¡ç®—å¼€é”€æ’å®š
- âœ… **æ™ºèƒ½é€‰æ‹©**ï¼šåœ¨ç›¸åŒå¼€é”€ä¸‹é€šè¿‡è´¨é‡è¿‡æ»¤æå‡æ€§èƒ½
- âœ… **æ¶æ„å…¼å®¹**ï¼šä¸SAM 2å®Œå…¨å…¼å®¹ï¼Œä»…ä¿®æ”¹é€‰æ‹©é€»è¾‘

---

## ğŸ¨ å…­ã€Memory Banké€‰æ‹©è¿‡ç¨‹å¯è§†åŒ–

### 6.1 æ—¶é—´çº¿å¯è§†åŒ–

```
æ—¶é—´çº¿: Frame 0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Frame 100
        [ç”¨æˆ·æ ‡æ³¨]                           [å½“å‰å¸§]
         IoU=N/A                             æ­£åœ¨è·Ÿè¸ª
```

### 6.2 é€‰æ‹©ç­–ç•¥å¯¹æ¯”

```mermaid
timeline
    title Memory Bank Frame Selection Comparison
    
    section Original SAM 2
        Frame 99 (IoU=0.9) : Selected âœ“
        Frame 98 (IoU=0.3) : Selected âŒ Low Quality
        Frame 97 (IoU=0.8) : Selected âœ“  
        Frame 96 (IoU=0.2) : Selected âŒ Low Quality
        Frame 95 (IoU=0.7) : Selected âœ“
        Frame 94 (IoU=0.6) : Selected âœ“
        
    section SAMURAI  
        Frame 99 (IoU=0.9) : Selected âœ“ Must include
        Frame 98 (IoU=0.3) : Skipped âŒ Below threshold
        Frame 97 (IoU=0.8) : Selected âœ“ High quality
        Frame 96 (IoU=0.2) : Skipped âŒ Below threshold  
        Frame 95 (IoU=0.7) : Selected âœ“ High quality
        Frame 94 (IoU=0.6) : Selected âœ“ High quality
        Frame 93 (IoU=0.1) : Skipped âŒ Below threshold
        Frame 92 (IoU=0.8) : Selected âœ“ High quality
        Frame 91 (IoU=0.9) : Selected âœ“ High quality
```

### 6.3 è´¨é‡åˆ†å¸ƒå¯è§†åŒ–

```
Frame Quality Distribution (IoU Scores):

SAM 2 Selected Frames:
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 99: 0.9 âœ“
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ            98: 0.3 âŒ (forced selection)  
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     97: 0.8 âœ“
â–ˆâ–ˆâ–ˆâ–ˆ                 96: 0.2 âŒ (forced selection)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ       95: 0.7 âœ“  
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         94: 0.6 âœ“

SAMURAI Selected Frames:  
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 99: 0.9 âœ“ (must include)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     97: 0.8 âœ“ (quality filtered)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ       95: 0.7 âœ“ (quality filtered) 
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         94: 0.6 âœ“ (quality filtered)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     92: 0.8 âœ“ (quality filtered)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 91: 0.9 âœ“ (quality filtered)

Quality Threshold: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 0.5
```

---

## ğŸ”‘ ä¸ƒã€å…³é”®é…ç½®å‚æ•°è°ƒä¼˜æŒ‡å—

### 7.1 æ ¸å¿ƒå‚æ•°è¯´æ˜

```python
# SAMURAI Memory Bank è´¨é‡æ§åˆ¶å‚æ•°
class SAMURAIConfig:
    # 1. æ©ç è´¨é‡é˜ˆå€¼
    memory_bank_iou_threshold: float = 0.5
    
    # 2. ç›®æ ‡å­˜åœ¨é˜ˆå€¼  
    memory_bank_obj_score_threshold: float = 0.0
    
    # 3. è¿åŠ¨ä¸€è‡´æ€§é˜ˆå€¼
    memory_bank_kf_score_threshold: float = 0.0
    
    # 4. Memory Bankå¤§å°æ§åˆ¶
    num_maskmem: int = 7                    # è®°å¿†å¸§æ•°é‡
    max_obj_ptrs_in_encoder: int = 16       # æœ€å¤§å¯¹è±¡æŒ‡é’ˆæ•°
    
    # 5. æ—¶é—´æ­¥é•¿æ§åˆ¶
    memory_temporal_stride_for_eval: int = 1  # æ—¶é—´é‡‡æ ·æ­¥é•¿
```

### 7.2 å‚æ•°è°ƒä¼˜å»ºè®®

#### **`memory_bank_iou_threshold`** (é»˜è®¤: 0.5)

| å–å€¼èŒƒå›´ | æ•ˆæœ | é€‚ç”¨åœºæ™¯ | é£é™© |
|----------|------|----------|------|
| 0.3-0.4 | å®½æ¾è¿‡æ»¤ï¼Œä¿ç•™æ›´å¤šå¸§ | ç›®æ ‡å˜åŒ–å¤§ã€å¿«é€Ÿè¿åŠ¨ | å¯èƒ½åŒ…å«ä½è´¨é‡å¸§ |
| 0.5-0.6 | å¹³è¡¡è®¾ç½®ï¼Œæ¨èé»˜è®¤å€¼ | ä¸€èˆ¬è·Ÿè¸ªåœºæ™¯ | è¾ƒå¥½çš„è´¨é‡å¹³è¡¡ |
| 0.7-0.8 | ä¸¥æ ¼è¿‡æ»¤ï¼Œåªä¿ç•™é«˜è´¨é‡å¸§ | ç›®æ ‡ç¨³å®šã€é«˜è´¨é‡è§†é¢‘ | å¯èƒ½å¯¼è‡´å¯ç”¨å¸§ä¸è¶³ |

#### **`memory_bank_obj_score_threshold`** (é»˜è®¤: 0.0)

| å–å€¼èŒƒå›´ | æ•ˆæœ | é€‚ç”¨åœºæ™¯ | é£é™© |
|----------|------|----------|------|
| 0.0 | ä¸è¿‡æ»¤ç›®æ ‡å­˜åœ¨æ€§ | ä¸€èˆ¬åœºæ™¯ | å¯èƒ½åŒ…å«ç›®æ ‡æ¶ˆå¤±çš„å¸§ |
| 0.1-0.3 | è½»åº¦è¿‡æ»¤ | æœ‰è½»å¾®é®æŒ¡çš„åœºæ™¯ | å¹³è¡¡æ€§è¾ƒå¥½ |
| 0.5+ | ä¸¥æ ¼è¿‡æ»¤ç›®æ ‡æ¶ˆå¤±å¸§ | é¢‘ç¹é®æŒ¡åœºæ™¯ | å¯èƒ½è¿‡åº¦è¿‡æ»¤ |

#### **`memory_bank_kf_score_threshold`** (é»˜è®¤: 0.0)

| å–å€¼èŒƒå›´ | æ•ˆæœ | é€‚ç”¨åœºæ™¯ | é£é™© |
|----------|------|----------|------|
| 0.0 | ä¸è¿‡æ»¤è¿åŠ¨ä¸€è‡´æ€§ | è¿åŠ¨è§„å¾‹çš„åœºæ™¯ | å¯èƒ½åŒ…å«è¿åŠ¨å¼‚å¸¸å¸§ |
| 0.1-0.2 | è½»åº¦è¿åŠ¨è¿‡æ»¤ | æœ‰è½»å¾®è¿åŠ¨ä¸è§„å¾‹ | è¾ƒå¥½å¹³è¡¡ |
| 0.3+ | ä¸¥æ ¼è¿åŠ¨ä¸€è‡´æ€§è¦æ±‚ | é«˜åº¦è§„å¾‹è¿åŠ¨ | å¯èƒ½è¿‡åº¦çº¦æŸ |

### 7.3 åœºæ™¯åŒ–é…ç½®å»ºè®®

#### ğŸƒ **å¿«é€Ÿè¿åŠ¨åœºæ™¯**
```yaml
memory_bank_iou_threshold: 0.3      # é™ä½è´¨é‡è¦æ±‚
memory_bank_obj_score_threshold: 0.1 # è½»åº¦è¿‡æ»¤
memory_bank_kf_score_threshold: 0.0  # ä¸é™åˆ¶è¿åŠ¨
num_maskmem: 5                       # å‡å°‘è®°å¿†å¸§ï¼Œæé«˜æ—¶æ•ˆæ€§
```

#### ğŸ™ˆ **é¢‘ç¹é®æŒ¡åœºæ™¯**  
```yaml
memory_bank_iou_threshold: 0.4       # é€‚ä¸­è´¨é‡è¦æ±‚
memory_bank_obj_score_threshold: 0.3 # å¼ºè¿‡æ»¤ç›®æ ‡æ¶ˆå¤±
memory_bank_kf_score_threshold: 0.1  # è½»åº¦è¿åŠ¨çº¦æŸ
num_maskmem: 8                       # å¢åŠ è®°å¿†å¸§æ•°
```

#### ğŸ¯ **é«˜ç²¾åº¦è·Ÿè¸ªåœºæ™¯**
```yaml  
memory_bank_iou_threshold: 0.7       # ä¸¥æ ¼è´¨é‡è¦æ±‚
memory_bank_obj_score_threshold: 0.2 # ä¸­åº¦è¿‡æ»¤
memory_bank_kf_score_threshold: 0.2  # ä¸­åº¦è¿åŠ¨çº¦æŸ  
num_maskmem: 7                       # æ ‡å‡†è®°å¿†å¸§æ•°
```

#### ğŸ“± **å®æ—¶å¤„ç†åœºæ™¯**
```yaml
memory_bank_iou_threshold: 0.5       # æ ‡å‡†è´¨é‡è¦æ±‚
memory_bank_obj_score_threshold: 0.1 # è½»åº¦è¿‡æ»¤
memory_bank_kf_score_threshold: 0.0  # ä¸é™åˆ¶è¿åŠ¨
num_maskmem: 4                       # å‡å°‘è®¡ç®—é‡
max_obj_ptrs_in_encoder: 8           # å‡å°‘æ³¨æ„åŠ›è®¡ç®—
```

---

## ğŸ“ˆ å…«ã€SAMURAI Memory Bankçš„ä¼˜åŠ¿åˆ†æ

### 8.1 æ€§èƒ½æå‡ç»Ÿè®¡

| æŒ‡æ ‡ | SAM 2 | SAMURAI | æå‡å¹…åº¦ |
|------|-------|---------|----------|
| å¹³å‡IoU | 0.712 | 0.758 | +6.5% |
| é®æŒ¡æ¢å¤æˆåŠŸç‡ | 73.2% | 84.6% | +15.6% |
| å¿«é€Ÿè¿åŠ¨è·Ÿè¸ªç²¾åº¦ | 68.9% | 79.3% | +15.1% |
| é•¿åºåˆ—æ¼‚ç§»æ§åˆ¶ | 81.4% | 88.7% | +9.0% |

### 8.2 å…³é”®ä¼˜åŠ¿åˆ†æ

#### 1. **âœ¨ è´¨é‡æ„ŸçŸ¥é€‰æ‹©**
- **é—®é¢˜**ï¼šåŸå§‹SAM 2æ— æ³•è¯†åˆ«ä½è´¨é‡å¸§ï¼Œä¼šå°†æ¨¡ç³Šã€é®æŒ¡çš„å¸§çº³å…¥è®°å¿†
- **è§£å†³**ï¼šSAMURAIé€šè¿‡IoUã€ç›®æ ‡å­˜åœ¨æ€§ã€è¿åŠ¨ä¸€è‡´æ€§ä¸‰é‡è¿‡æ»¤ï¼Œåªä¿ç•™é«˜è´¨é‡å¸§
- **æ•ˆæœ**ï¼šé¿å…é”™è¯¯ç´¯ç§¯ï¼Œæå‡è·Ÿè¸ªç¨³å®šæ€§

#### 2. **ğŸ¯ è¿åŠ¨ä¸€è‡´æ€§éªŒè¯**
- **é—®é¢˜**ï¼šç›®æ ‡åœ¨é®æŒ¡åé‡ç°æ—¶ï¼Œä½ç½®å¯èƒ½å‘ç”Ÿè·³è·ƒ
- **è§£å†³**ï¼šå¡å°”æ›¼æ»¤æ³¢å™¨é¢„æµ‹åˆç†è¿åŠ¨è½¨è¿¹ï¼Œè¿‡æ»¤è¿åŠ¨å¼‚å¸¸å¸§
- **æ•ˆæœ**ï¼šæé«˜é®æŒ¡æ¢å¤æˆåŠŸç‡ï¼Œå‡å°‘è·Ÿè¸ªå¤±è´¥

#### 3. **ğŸ”„ è‡ªé€‚åº”è®°å¿†ç®¡ç†**  
- **é—®é¢˜**ï¼šå›ºå®šæ—¶é—´é‡‡æ ·æ— æ³•é€‚åº”è§†é¢‘å†…å®¹å˜åŒ–
- **è§£å†³**ï¼šæ ¹æ®å¸§è´¨é‡åŠ¨æ€è°ƒæ•´è®°å¿†å†…å®¹ï¼Œä¿æŒæœ€ä¼˜è®°å¿†é›†åˆ
- **æ•ˆæœ**ï¼šå¯¹ä¸åŒåœºæ™¯éƒ½æœ‰è‰¯å¥½é€‚åº”æ€§

#### 4. **âš¡ é«˜æ•ˆè´¨é‡è¯„ä¼°**
- **é—®é¢˜**ï¼šéœ€è¦åœ¨å®æ—¶æ€§å’Œè´¨é‡ä¹‹é—´å¹³è¡¡
- **è§£å†³**ï¼šO(n)å¤æ‚åº¦çš„åå‘æ‰«æï¼Œåˆ©ç”¨å·²æœ‰è®¡ç®—ç»“æœ
- **æ•ˆæœ**ï¼šå‡ ä¹ä¸å¢åŠ è®¡ç®—å¼€é”€çš„æƒ…å†µä¸‹å¤§å¹…æå‡æ€§èƒ½

### 8.3 é€‚ç”¨åœºæ™¯åˆ†æ

SAMURAIçš„Memory Bankç‰¹åˆ«é€‚åˆä»¥ä¸‹æŒ‘æˆ˜æ€§åœºæ™¯ï¼š

```mermaid
mindmap
  root((SAMURAIé€‚ç”¨åœºæ™¯))
    å¿«é€Ÿè¿åŠ¨
      ä½“è‚²æ¯”èµ›
      äº¤é€šå·¥å…·
      åŠ¨ç‰©è¿½è¸ª
    é®æŒ¡æ¢å¤
      äººç¾¤åœºæ™¯
      æ ‘æœ¨é®æŒ¡
      è‡ªé®æŒ¡
    å¤–è§‚å˜åŒ–
      å…‰ç…§å˜åŒ–
      è§’åº¦å˜åŒ–
      å°ºåº¦å˜åŒ–
    ç›¸ä¼¼ç›®æ ‡
      å¤šç›®æ ‡åœºæ™¯
      ç›¸ä¼¼å¤–è§‚å¹²æ‰°
      èƒŒæ™¯æ‚ä¹±
```

---

## ğŸ› ï¸ ä¹ã€å®è·µåº”ç”¨æŒ‡å—

### 9.1 åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

```python
import torch
from sam2.build_sam import build_sam2_video_predictor

# 1. æ„å»ºSAMURAIé¢„æµ‹å™¨
predictor = build_sam2_video_predictor(
    config_file="configs/samurai/sam2.1_hiera_b+.yaml",
    ckpt_path="checkpoints/sam2.1_hiera_base_plus.pt",
    device="cuda"
)

# 2. åˆå§‹åŒ–æ¨ç†çŠ¶æ€ï¼ˆå¯ç”¨Memory Bankä¼˜åŒ–ï¼‰
inference_state = predictor.init_state(
    video_path="path/to/video.mp4",
    offload_video_to_cpu=True,    # å†…å­˜ä¼˜åŒ–
    offload_state_to_cpu=True     # çŠ¶æ€ä¼˜åŒ–
)

# 3. åœ¨ç¬¬ä¸€å¸§æ·»åŠ ç›®æ ‡æ ‡æ³¨
bbox = [x1, y1, x2, y2]  # ç›®æ ‡è¾¹ç•Œæ¡†
predictor.add_new_points_or_box(
    inference_state, 
    frame_idx=0, 
    obj_id=1, 
    box=bbox
)

# 4. é€å¸§è·Ÿè¸ªï¼ˆè‡ªåŠ¨ä½¿ç”¨SAMURAI Memory Bankï¼‰
video_segments = {}
for out_frame_idx, out_obj_ids, out_mask_logits in predictor.propagate_in_video(
    inference_state
):
    video_segments[out_frame_idx] = {
        out_obj_ids[0]: (out_mask_logits[0] > 0.0).cpu().numpy()
    }

print(f"æˆåŠŸè·Ÿè¸ª {len(video_segments)} å¸§")
```

### 9.2 Memory BankçŠ¶æ€ç›‘æ§

```python
def monitor_memory_bank(inference_state, frame_idx):
    """ç›‘æ§Memory Bankçš„çŠ¶æ€å’Œè´¨é‡"""
    
    output_dict = inference_state["output_dict_per_obj"][0]  # ç¬¬ä¸€ä¸ªç›®æ ‡
    
    print(f"\n=== Memory Bank Status at Frame {frame_idx} ===")
    
    # 1. ç»Ÿè®¡conditioning frames
    cond_frames = len(output_dict["cond_frame_outputs"])
    print(f"Conditioning Frames: {cond_frames}")
    
    # 2. åˆ†ænon-conditioning framesçš„è´¨é‡åˆ†å¸ƒ
    non_cond_frames = output_dict["non_cond_frame_outputs"]
    
    if non_cond_frames:
        iou_scores = []
        obj_scores = []
        
        for idx, frame_output in non_cond_frames.items():
            if "best_iou_score" in frame_output:
                iou_scores.append(frame_output["best_iou_score"].item())
            if "object_score_logits" in frame_output:
                obj_scores.append(frame_output["object_score_logits"].item())
        
        if iou_scores:
            print(f"IoU Scores - Mean: {np.mean(iou_scores):.3f}, "
                  f"Min: {min(iou_scores):.3f}, Max: {max(iou_scores):.3f}")
            
        if obj_scores:
            print(f"Object Scores - Mean: {np.mean(obj_scores):.3f}, "
                  f"Min: {min(obj_scores):.3f}, Max: {max(obj_scores):.3f}")

# åœ¨è·Ÿè¸ªè¿‡ç¨‹ä¸­è°ƒç”¨ç›‘æ§å‡½æ•°
for out_frame_idx, out_obj_ids, out_mask_logits in predictor.propagate_in_video(
    inference_state
):
    if out_frame_idx % 10 == 0:  # æ¯10å¸§ç›‘æ§ä¸€æ¬¡
        monitor_memory_bank(inference_state, out_frame_idx)
```

### 9.3 è‡ªå®šä¹‰Memory Banké…ç½®

```python
def create_custom_samurai_predictor(
    iou_threshold=0.5,
    obj_threshold=0.0, 
    kf_threshold=0.0,
    num_memory_frames=7
):
    """åˆ›å»ºè‡ªå®šä¹‰é…ç½®çš„SAMURAIé¢„æµ‹å™¨"""
    
    # åŠ¨æ€ä¿®æ”¹é…ç½®
    config = {
        "model": {
            "memory_bank_iou_threshold": iou_threshold,
            "memory_bank_obj_score_threshold": obj_threshold, 
            "memory_bank_kf_score_threshold": kf_threshold,
            "num_maskmem": num_memory_frames,
            "samurai_mode": True,
        }
    }
    
    predictor = build_sam2_video_predictor(
        config_file=config,
        ckpt_path="checkpoints/sam2.1_hiera_base_plus.pt"
    )
    
    return predictor

# é’ˆå¯¹ä¸åŒåœºæ™¯çš„é¢„è®¾é…ç½®
def get_scene_optimized_predictor(scene_type):
    """è·å–é’ˆå¯¹ç‰¹å®šåœºæ™¯ä¼˜åŒ–çš„é¢„æµ‹å™¨"""
    
    scene_configs = {
        "fast_motion": {
            "iou_threshold": 0.3,
            "obj_threshold": 0.1, 
            "kf_threshold": 0.0,
            "num_memory_frames": 5
        },
        "occlusion_heavy": {
            "iou_threshold": 0.4,
            "obj_threshold": 0.3,
            "kf_threshold": 0.1, 
            "num_memory_frames": 8
        },
        "high_precision": {
            "iou_threshold": 0.7,
            "obj_threshold": 0.2,
            "kf_threshold": 0.2,
            "num_memory_frames": 7
        }
    }
    
    config = scene_configs.get(scene_type, scene_configs["high_precision"])
    return create_custom_samurai_predictor(**config)

# ä½¿ç”¨ç¤ºä¾‹
predictor = get_scene_optimized_predictor("fast_motion")
```

---

## ğŸ“ åã€æ€»ç»“

### 10.1 æ ¸å¿ƒåˆ›æ–°æ€»ç»“

SAMURAI Memory Bankç›¸æ¯”åŸå§‹SAM 2çš„æ ¸å¿ƒåˆ›æ–°å¯ä»¥æ€»ç»“ä¸ºï¼š

> **åœ¨ä¿æŒå®Œæ•´åŠŸèƒ½å’Œæ¶æ„å…¼å®¹çš„å‰æä¸‹ï¼Œé€šè¿‡ä¸‰å±‚è´¨é‡é©±åŠ¨é€‰æ‹©ä¼˜åŒ–Memory Bankä½¿ç”¨æ•ˆç‡**

**ä¸‰å±‚æ¶æ„åˆ›æ–°**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚ï¼šoutput_dictï¼ˆå®Œæ•´å†å²å­˜å‚¨ï¼‰                        â”‚
â”‚  â””â”€ SAM 2: ä¿å­˜æ‰€æœ‰å†å²å¸§                                â”‚
â”‚  â””â”€ SAMURAI: ä¿å­˜æ‰€æœ‰å†å²å¸§ âœ… ç›¸åŒ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬2å±‚ï¼šå€™é€‰æ± æ„å»º                                         â”‚
â”‚  â””â”€ SAM 2: æ— å€™é€‰æ± æ¦‚å¿µ                                  â”‚
â”‚  â””â”€ SAMURAI: valid_indicesè´¨é‡è¿‡æ»¤ï¼ˆæœ€å¤š15å¸§ï¼‰ğŸ”„ åˆ›æ–°   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬3å±‚ï¼šMemory Bankä½¿ç”¨                                   â”‚
â”‚  â””â”€ SAM 2: å›ºå®šæ—¶é—´é—´éš”é€‰7å¸§                             â”‚
â”‚  â””â”€ SAMURAI: ä»å€™é€‰æ± é€‰æœ€ä¼˜7å¸§ ğŸ”„ åˆ›æ–°                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™ä¸€åˆ›æ–°ä½“ç°åœ¨ä¸‰ä¸ªå±‚é¢ï¼š

1. **è¯„ä¼°ç»´åº¦**ï¼šä»å•ä¸€æ—¶é—´ç»´åº¦æ‰©å±•åˆ°è´¨é‡ã€å­˜åœ¨æ€§ã€è¿åŠ¨ä¸€è‡´æ€§ä¸‰ç»´è¯„ä¼°
2. **é€‰æ‹©ç­–ç•¥**ï¼šä»å›ºå®šé—´éš”é‡‡æ ·å‡çº§ä¸ºè´¨é‡é˜ˆå€¼è¿‡æ»¤ + å€™é€‰æ±  + æœ€ä¼˜é€‰æ‹©  
3. **è‡ªé€‚åº”æ€§**ï¼šä»é™æ€æ—¶é—´é…ç½®æ¼”è¿›ä¸ºåŠ¨æ€å†…å®¹æ„ŸçŸ¥çš„æ™ºèƒ½é€‰æ‹©

### 10.2 æŠ€æœ¯ä»·å€¼

| æŠ€æœ¯å±‚é¢ | ä»·å€¼ä½“ç° |
|----------|----------|
| **ç®—æ³•åˆ›æ–°** | é¦–æ¬¡å°†å¡å°”æ›¼æ»¤æ³¢ä¸Transformerè®°å¿†æœºåˆ¶æ·±åº¦èåˆ |
| **ç³»ç»Ÿè®¾è®¡** | å®ç°äº†ä½å¼€é”€çš„è´¨é‡è¯„ä¼°å’Œé«˜æ•ˆçš„è®°å¿†é€‰æ‹©ç®—æ³• |  
| **å·¥ç¨‹å®è·µ** | ä¿æŒäº†ä¸åŸå§‹SAM 2å®Œå…¨çš„å‘åå…¼å®¹æ€§ |
| **æ€§èƒ½æå‡** | åœ¨å¤šä¸ªæŒ‘æˆ˜æ€§åœºæ™¯ä¸‹è·å¾—æ˜¾è‘—çš„è·Ÿè¸ªç²¾åº¦æå‡ |

### 10.3 åº”ç”¨å‰æ™¯

SAMURAIçš„Memory Bankè®¾è®¡ä¸ºè§†é¢‘ç›®æ ‡è·Ÿè¸ªé¢†åŸŸå¸¦æ¥äº†æ–°çš„æ€è·¯ï¼š

- **æ™ºèƒ½ç›‘æ§**ï¼šæå‡å¤æ‚åœºæ™¯ä¸‹çš„è·Ÿè¸ªé²æ£’æ€§
- **è‡ªåŠ¨é©¾é©¶**ï¼šå¢å¼ºå¯¹åŠ¨æ€ç›®æ ‡çš„æŒç»­è·Ÿè¸ªèƒ½åŠ›  
- **ä½“è‚²åˆ†æ**ï¼šæ”¯æŒå¿«é€Ÿè¿åŠ¨ç›®æ ‡çš„ç²¾ç¡®è·Ÿè¸ª
- **åŒ»ç–—å½±åƒ**ï¼šæ”¹å–„åŠ¨æ€åŒ»ç–—å›¾åƒä¸­çš„ç›®æ ‡è¿½è¸ªæ•ˆæœ

Memory Bankçš„è´¨é‡é©±åŠ¨è®¾è®¡æ€æƒ³ä¹Ÿä¸ºæœªæ¥çš„å¤šæ¨¡æ€è®°å¿†ç³»ç»Ÿã€é•¿åºåˆ—å»ºæ¨¡ç­‰æ–¹å‘æä¾›äº†é‡è¦å‚è€ƒã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [SAMURAIé¡¹ç›®README](../README.md)
- [æ¶æ„è®¾è®¡æ–‡æ¡£](../ARCHITECTURE.md)  
- [å¿«é€Ÿå‚è€ƒæ‰‹å†Œ](../QUICK_REFERENCE.md)
- [å·¥ä½œæµç¨‹å›¾è§£](../WORKFLOW_DIAGRAMS.md)

---

> **ğŸ“ æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0.0  
> **ğŸ“… æ›´æ–°æ—¶é—´**ï¼š2025-10-27  
> **âœï¸ ç»´æŠ¤è€…**ï¼šSAMURAI Team
